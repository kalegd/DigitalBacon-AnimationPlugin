const{Assets:e,DigitalBaconUI:t,ProjectHandler:s,THREE:i,dynamicAssets:r,getMenuController:a,isEditor:o}=window.DigitalBacon,{CustomAssetEntity:n}=e,l=[new i.Vector3,new i.Vector3],d="2d227485-0b34-40a4-873d-2a0782d034c6",p=new t.Style({materialColor:6514283});class AnimationController extends n{constructor(e={}){e.assetId=AnimationController.assetId,super(e),o()&&(this._createMesh(),this._speed=1)}_getDefaultName(){return AnimationController.assetName}_createMesh(){let e=new t.Body({height:.3,materialColor:0,width:.45}),i=new t.Div({backgroundVisible:!0,borderRadius:.01,height:.035,justifyContent:"center",materialColor:9868950,width:.3}),r=new t.Text("Start Preview",{color:16777215,fontSize:.019}),a=this._createNumberRow("Seek",(e=>{let t=s.getAssets(),i=Number.parseFloat(e);for(let e in t)t[e].assetId==d&&t[e]._setTime(i)})),o=this._createNumberRow("Speed",(e=>{s.getAssets();let t=Number.parseFloat(e);this._speed=t||1}));i.add(r),e.add(i),e.add(a),e.add(o),this._object.add(e),i.onClickAndTouch=()=>this._startPreview(),i.pointerInteractable.addHoveredCallback((e=>{e?i.addStyle(p):i.removeStyle(p)}))}_createNumberRow(e,s){let i=new t.Span,r=new t.Text(e,{color:16777215,fontSize:.019}),a=new t.NumberInput({fontSize:.019,height:.03,width:.17});return a.onChange=s,a.onEnter=()=>a.blur(),i.add(r),i.add(a),i}setPositionFromMenu(){let e=a();e.getPosition(l[0]),e.getDirection(l[1]).normalize().divideScalar(4),l[0].sub(l[1]).roundWithPrecision(5);let t=l[0].toArray();this.position=t,this.parent.object.worldToLocal(this.object.position)}registerAnimationPathClass(e){this._animationPathClass=e}_startPreview(){let e=s.getAssets();this._pathAssets=[],this._maxTime=0;for(let t in e)e[t].assetId==d&&(this._pathAssets.push(e[t]),this._maxTime=Math.max(this._maxTime,e[t]._maxTime));0!=this._pathAssets.length&&(this._time=0,this._reverse=!1,r.add(this))}update(e){this._time+=this._speed*(this._reverse?-e:e),this._time>this._maxTime?this._reverse=!0:this._time<0&&(this._time=0);for(let e of this._pathAssets)e._setTime(this._time);0==this._time&&r.delete(this)}static assetId="d4706106-d21d-4933-a665-6c5f3b6cb383";static assetName="Animation Controller";static isPrivate=!0}const{Assets:h,EditorHelpers:m}=window.DigitalBacon,{CustomAsset:u}=h,{CustomAssetHelper:c,EditorHelperFactory:_}=m,{EnumField:f}=c.FieldTypes,g={Linear:"linear",Sinusoidal:"sinusoidal",Quadratic:"quadratic",Cubic:"cubic",Quartic:"quartic",Quintic:"quintic",Exponential:"exponential",Circular:"circular",Back:"back",Bounce:"bounce",Elastic:"elastic",Step:"step"},P={"Ease In":"easeIn","Ease Out":"easeOut","Ease In & Out":"easeInOut"};class Interpolation extends u{constructor(e={}){super(e),this._parameter=e.parameter,this._type=e.type||"linear",this._easing=e.easing||"easeInOut"}_getDefaultName(){return Interpolation.assetName}exportParams(){let e=super.exportParams();return e.parameter=this._parameter,e.type=this._type,e.easing=this._easing,e}get parameter(){return this._parameter}get type(){return this._type}get easing(){return this._easing}set parameter(e){this._parameter=e}set type(e){this._type=e}set easing(e){this._easing=e}registerKeyframe(e){this._keyframe=e}getValue(e,t){if(!this._keyframe)return;if(!t||e<=this._keyframe.time)return this._keyframe[this._parameter];if(e>=t.time)return t[this._parameter];let s=(e-this._keyframe.time)/(t.time-this._keyframe.time);if("sinusoidal"==this._type)s=this._getSinusoidalTime(s);else if("quadratic"==this._type)s=this._getPolynomialTime(s,2);else if("cubic"==this._type)s=this._getPolynomialTime(s,3);else if("quartic"==this._type)s=this._getPolynomialTime(s,4);else if("quintic"==this._type)s=this._getPolynomialTime(s,5);else if("exponential"==this._type)s=this._getExponentialTime(s);else if("circular"==this._type)s=this._getCircularTime(s);else if("back"==this._type)s=this._getBackTime(s);else if("bounce"==this._type)s=this._getBounceTime(s);else if("elastic"==this._type)s=this._getElasticTime(s);else if("linear"!=this._type)return this._getStepValue(s,t);return this._getLinearValue(s,t)}_getSinusoidalTime(e){return"easeIn"==this._easing?1-Math.cos(e*Math.PI/2):"easeOut"==this._easing?Math.sin(e*Math.PI/2):.5*(1-Math.cos(e*Math.PI))}_getPolynomialTime(e,t){return"easeIn"==this._easing?e**t:"easeOut"==this._easing?1-(1-e)**t:e<.5?2**(t-1)*e**t:1-(-2*e+2)**t/2}_getExponentialTime(e){return 0==e?0:1==e?1:"easeIn"==this._easing?2**(10*(e-1)):"easeOut"==this._easing?1-2**(-10*e):e<.5?.5*2**(10*(2*e-1)):1-.5*2**(-10*(2*e-1))}_getCircularTime(e){return"easeIn"==this._easing?1-Math.sqrt(1-e*e):"easeOut"==this._easing?Math.sqrt(e*(2-e)):e<.5?(1-Math.sqrt(1-4*e**2))/2:(Math.sqrt(1-(-2*e+2)**2)+1)/2}_getBackTime(e){let t=1.70158;if("easeIn"==this._easing){return(t+1)*e**3-t*e**2}if("easeOut"==this._easing){return 1+(t+1)*(e-1)**3+t*(e-1)**2}if(e<.5){let s=1.525*t;return(2*e)**2*(2*(s+1)*e-s)/2}{let s=1.525*t;return((2*e-2)**2*((s+1)*(2*e-2)+s)+2)/2}}_getBounceTime(e){return"easeIn"==this._easing?1-this._getEaseOutBounce(1-e):"easeOut"==this._easing?this._getEaseOutBounce(e):e<.5?(1-this._getEaseOutBounce(1-2*e))/2:(1+this._getEaseOutBounce(2*e-1))/2}_getEaseOutBounce(e){let t=7.5625,s=2.75;return e<1/s?t*e*e:e<2/s?t*(e-1.5/s)**2+.75:e<2.5/s?t*(e-2.25/s)**2+.9375:t*(e-2.625/s)**2+.984375}_getElasticTime(e){let t=2*Math.PI/3,s=2*Math.PI/4.5;return 0==e?0:1==e?1:"easeIn"==this._easing?-(2**(10*e-10))*Math.sin((10*e-10.75)*t):"easeOut"==this._easing?2**(-10*e)*Math.sin((10*e-.75)*t)+1:e<.5?2**(20*e-10)*Math.sin((20*e-11.125)*s)/-2:2**(-20*e+10)*Math.sin((20*e-11.125)*s)/2+1}_getLinearValue(e,t){console.error("_getLinearValue(...) should be overwritten")}_getStepValue(e){return e<1?this._keyframe[this._parameter]:nextKeyframe[this._parameter]}onAddToProject(){this._keyframe&&this._keyframe.addInterpolation(this._id)}onRemoveFromProject(){this._keyframe.removeInterpolation(this._id)}static assetName="Interpolation";static isPrivate=!0}class InterpolationHelper extends c{constructor(e){super(e)}static fields=[{parameter:"type",name:"Interpolation Type",map:g,type:f},{parameter:"easing",name:"Easing",map:P,type:f}]}_.registerEditorHelper(InterpolationHelper,Interpolation);const{LibraryHandler:y,ProjectHandler:I}=window.DigitalBacon;class ColorInterpolation extends Interpolation{constructor(e={}){e.assetId=ColorInterpolation.assetId,super(e)}_getDefaultName(){return ColorInterpolation.assetName}_getLinearValue(e,t){let{r:s,g:i,b:r}=this._hexToRGB(this._keyframe[this._parameter]),{r:a,g:o,b:n}=this._hexToRGB(t[this._parameter]),l=Math.round(s+(a-s)*e),d=Math.round(i+(o-i)*e),p=Math.round(r+(n-r)*e);return this._rgbToHex(l,d,p)}_hexToRGB(e){return{r:e>>16&255,g:e>>8&255,b:255&e}}_rgbToHex(e,t,s){return e<<16|t<<8|s}static assetId="2889a453-7a29-465f-9542-f8ad01156cb8";static assetName="Color Interpolation";static isPrivate=!0}I.registerAsset(ColorInterpolation),y.loadPrivate(ColorInterpolation);const{LibraryHandler:b,ProjectHandler:v,THREE:A}=window.DigitalBacon;new A.Euler;const E=[new A.Quaternion,new A.Quaternion];class EulerInterpolation extends Interpolation{constructor(e={}){e.assetId=EulerInterpolation.assetId,super(e)}_getDefaultName(){return EulerInterpolation.assetName}exportParams(){return super.exportParams()}_getLinearValue(e,t){return workingEulers[0].fromArray(this._keyframe[this._parameter]),workingEulers[1].fromArray(t[this._parameter]),E[0].setFromEuler(workingEulers[0]),E[1].setFromEuler(workingEulers[1]),E[0].slerp(E[1],e),workingEulers[0].setFromQuaternion(E[0]),workingEulers[0].toArray()}static assetId="02fc385c-c981-445f-a448-4ea2b5729953";static assetName="Euler Interpolation";static isPrivate=!0}v.registerAsset(EulerInterpolation),b.loadPrivate(EulerInterpolation);const{LibraryHandler:w,ProjectHandler:F}=window.DigitalBacon;class NumberInterpolation extends Interpolation{constructor(e={}){e.assetId=NumberInterpolation.assetId,super(e)}_getDefaultName(){return NumberInterpolation.assetName}_getLinearValue(e,t){return(t[this._parameter]-this._keyframe[this._parameter])*e+this._keyframe[this._parameter]}static assetId="e89be085-ee97-4702-bf2c-01ec0505a694";static assetName="Number Interpolation";static isPrivate=!0}F.registerAsset(NumberInterpolation),w.loadPrivate(NumberInterpolation);const{Assets:T,EditorHelpers:x,LibraryHandler:H,ProjectHandler:C,PubSub:j,THREE:S,getMenuController:M,isEditor:k,utils:N}=window.DigitalBacon,{CustomAssetEntity:B}=T,{CustomAssetEntityHelper:V,EditorHelperFactory:K}=x;V.FieldTypes;const L=[new S.Vector3,new S.Vector3];var O,D;class ControlPoint extends B{constructor(e={}){e.assetId=ControlPoint.assetId,super(e),e.position||this._setPositionFromMenu(),k()&&(this._lastPosition=this.position,this.update=this._editorUpdate)}_getDefaultName(){return ControlPoint.assetName}exportParams(){let e=super.exportParams();return e.parentId=null,e}_setPositionFromMenu(){let e=M();e.getPosition(L[0]),e.getDirection(L[1]).normalize().divideScalar(4),L[0].sub(L[1]).roundWithPrecision(5);let t=L[0].toArray();this.position=t,this.parent.object.worldToLocal(this.object.position)}registerInterpolation(e){this._object.visible=!0,this._interpolation=e;let t=e._keyframe?._animationPath;t&&this.addTo(t)}_editorUpdate(){let e=this.position;for(let t=0;t<3;t++)e[t]!=this._lastPosition[t]&&(this._lastPosition=e,this._interpolation&&this._interpolation.updateCurve())}static assetId="dedf4341-660f-46aa-b8d1-2c3c2ea3d534";static assetName="Control Point";static isPrivate=!0}if(C.registerAsset(ControlPoint),H.loadPrivate(ControlPoint),x){class ControlPointHelper extends V{constructor(e){super(e),this._createMesh()}_createMesh(){O||(O=new S.SphereGeometry(.025),D=new S.MeshBasicMaterial({color:16711680})),this._mesh=new S.Mesh(O,D),this._asset.visualEdit&&this._object.add(this._mesh)}updateVisualEdit(e){e?this._object.add(this._mesh):this._object.remove(this._mesh),super.updateVisualEdit(e)}static fields=["visualEdit","position"]}K.registerEditorHelper(ControlPointHelper,ControlPoint)}const{EditorHelpers:R,LibraryHandler:Q,ProjectHandler:z,THREE:q,isEditor:U}=window.DigitalBacon,{EditorHelperFactory:G}=R,{AssetSetField:W,EnumField:Y}=InterpolationHelper.FieldTypes,J={Line:"line",Bezier:"bezier",Spline:"spline"},X=new q.Vector3;var Z;class PositionInterpolation extends Interpolation{constructor(e={}){e.assetId=PositionInterpolation.assetId,super(e),this._curveType=e.curveType||"line",this._controlPoints=[],e.controlPoints?this.controlPoints=e.controlPoints:this.updateCurve()}_getDefaultName(){return PositionInterpolation.assetName}exportParams(){let e=super.exportParams();return e.controlPoints=this.controlPoints,e.curveType=this.curveType,e}registerKeyframe(e){super.registerKeyframe(e);for(let e of this._controlPoints)e.registerInterpolation(this);this.updateCurve()}getValue(e,t){let s=super.getValue(e,t);return s?(X.fromArray(s),this._keyframe._animationPath.object.localToWorld(X),X.toArray()):s}_getLinearValue(e,t){return"line"==this._curveType||0==this._controlPoints.length||e<0||e>1||!this._curve?X.copy(t.object.position).sub(this._keyframe.object.position).multiplyScalar(e).add(this._keyframe.object.position):this._curve.getPointAt(e,X),X.toArray()}_getStepValue(e,t){return e<1?this._keyframe.position:t.position}get controlPoints(){let e=[];for(let t of this._controlPoints)e.push(t.id);return e}get curveType(){return this._curveType}set controlPoints(e){for(let t of e)this.addControlPoint(t)}set curveType(e){this._curveType=e,this.updateCurve(),window.pi=this}addControlPoint(e){let t=z.getAsset(e);t&&(this._controlPoints.push(t),t.registerInterpolation(this),this.updateCurve())}removeControlPoint(e){this._controlPoints.push(e);let t=z.getAsset(e);if(!t)return;let s=this._controlPoints.indexOf(t);s>=0&&this._controlPoints.splice(s,1),this.updateCurve()}updateCurve(){let e=this._keyframe?._animationPath?.getNextKeyframeFor?.("position",this._keyframe),t=this._controlPoints.length;if(this._curveObject?.parent&&this._curveObject.parent.remove(this._curveObject),!e)return;if("line"==this._curveType||0==t)this._curve=new q.LineCurve3(this._keyframe.object.position,e.object.position);else if("bezier"==this._curveType)this._curve=1==t?new q.QuadraticBezierCurve3(this._keyframe.object.position,this._controlPoints[0].object.position,e.object.position):new q.CubicBezierCurve3(this._keyframe.object.position,this._controlPoints[0].object.position,this._controlPoints[1].object.position,e.object.position);else if("spline"==this._curveType){let t=[this._keyframe.object.position];for(let e of this._controlPoints)t.push(e.object.position);t.push(e.object.position),this._curve=new q.CatmullRomCurve3(t)}if(!U())return;let s=this._curve.getPoints(50),i=(new q.BufferGeometry).setFromPoints(s);Z||(Z=new q.LineDashedMaterial({color:16776960})),this._curveObject=new q.Line(i,Z),this._keyframe._animationPath.object.add(this._curveObject)}hideCurve(){this._curveObject?.parent&&this._curveObject.parent.remove(this._curveObject)}static assetId="3dcb0b91-80fc-4aaf-aac4-a991521c906c";static assetName="Position Interpolation";static isPrivate=!0}z.registerAsset(PositionInterpolation),Q.loadPrivate(PositionInterpolation);G.registerEditorHelper(class extends InterpolationHelper{constructor(e){super(e)}static fields=["type","easing",{parameter:"curveType",name:"Curve Type",map:J,type:Y},{parameter:"controlPoints",name:"Control Points",addFunction:"addControlPoint",removeFunction:"removeControlPoint",newOptionsFunction:()=>[ControlPoint.assetId],type:W}]},PositionInterpolation);const{EditorHelpers:$,LibraryHandler:ee,ProjectHandler:te,THREE:se}=window.DigitalBacon,{EditorHelperFactory:ie}=$,{CheckboxField:re,NumberField:ae}=InterpolationHelper.FieldTypes,oe=new se.Euler,ne=[new se.Quaternion,new se.Quaternion];class RotationInterpolation extends Interpolation{constructor(e={}){e.assetId=RotationInterpolation.assetId,super(e),this._useLongPath=e.useLongPath||!1,this._revolutions=e.revolutions||0}_getDefaultName(){return RotationInterpolation.assetName}exportParams(){let e=super.exportParams();return e.useLongPath=this._useLongPath,e.revolutions=this._revolutions,e}get useLongPath(){return this._useLongPath}get revolutions(){return this._revolutions}set useLongPath(e){this._useLongPath=e}set revolutions(e){this._revolutions=e}getValue(e,t){let s=super.getValue(e,t);return s?(oe.fromArray(s),ne[0].setFromEuler(oe),this._keyframe._animationPath.object.getWorldQuaternion(ne[1]).multiply(ne[0]),oe.setFromQuaternion(ne[1]),oe.toArray()):s}_getLinearValue(e,t){return ne[0].fromArray(this._slerpQuaternions(this._keyframe.object.quaternion,t.object.quaternion,e)),ne[0].normalize(),oe.setFromQuaternion(ne[0]),oe.toArray()}_slerpQuaternions(e,t,s){let i=e.normalize().toArray(),r=t.normalize().toArray(),a=i[0]*r[0]+i[1]*r[1]+i[2]*r[2]+i[3]*r[3],o=a<0?-1:1;this._revolutions%2==1&&(o*=-1),this._useLongPath&&(o*=-1);let n=-1===o?[-r[0],-r[1],-r[2],-r[3]]:r,l=Math.acos(a),d=l;this._revolutions&&(d=this._revolutions%2==0?this._revolutions*Math.PI+l:-this._revolutions*Math.PI-l);let p=Math.sin(d);if(Math.abs(p)<1e-6)return i;let h=Math.sin((1-s)*d),m=Math.sin(s*d);return[h*i[0]+m*n[0],h*i[1]+m*n[1],h*i[2]+m*n[2],h*i[3]+m*n[3]]}_getStepValue(e,t){return e<1?this._keyframe.rotation:t.rotation}static assetId="c8d59d21-88f1-4431-aefc-614b9ab58433";static assetName="Rotation Interpolation";static isPrivate=!0}te.registerAsset(RotationInterpolation),ee.loadPrivate(RotationInterpolation);ie.registerEditorHelper(class extends InterpolationHelper{constructor(e){super(e)}static fields=["type","easing",{parameter:"useLongPath",name:"Long Path",type:re},{parameter:"revolutions",name:"Revolutions",min:0,type:ae}]},RotationInterpolation);const{LibraryHandler:le,ProjectHandler:de,THREE:pe}=window.DigitalBacon,he=[new pe.Vector3,new pe.Vector3];class ScaleInterpolation extends Interpolation{constructor(e={}){e.assetId=ScaleInterpolation.assetId,super(e)}_getDefaultName(){return ScaleInterpolation.assetName}exportParams(){return super.exportParams()}getValue(e,t){let s=super.getValue(e,t);return s?(he[0].fromArray(s),this._keyframe._animationPath.object.getWorldScale(he[1]),he[0].multiply(he[1]),he[0].toArray()):s}_getLinearValue(e,t){return he[0].copy(t.object.scale).sub(this._keyframe.object.scale).multiplyScalar(e).add(this._keyframe.object.scale),he[0].toArray()}_getStepValue(e,t){return e<1?this._keyframe.scale:t.scale}static assetId="ede2dc59-168a-4753-be2d-62530fcf7d67";static assetName="Scale Interpolation";static isPrivate=!0}de.registerAsset(ScaleInterpolation),le.loadPrivate(ScaleInterpolation);const{EditorHelpers:me,LibraryHandler:ue,ProjectHandler:ce}=window.DigitalBacon,{EditorHelperFactory:_e}=me;class StepInterpolation extends Interpolation{constructor(e={}){e.assetId=StepInterpolation.assetId,super(e),this._type="step"}_getDefaultName(){return StepInterpolation.assetName}static assetId="6599906d-6fdc-4a51-9468-7e5eb3401b97";static assetName="Step Interpolation";static isPrivate=!0}ce.registerAsset(StepInterpolation),ue.loadPrivate(StepInterpolation);_e.registerEditorHelper(class extends InterpolationHelper{constructor(e){super(e)}static fields=[]},StepInterpolation);const{EditorHelpers:fe,LibraryHandler:ge,ProjectHandler:Pe}=window.DigitalBacon,{EditorHelperFactory:ye}=fe;class TextInterpolation extends Interpolation{constructor(e={}){e.assetId=TextInterpolation.assetId,super(e),this._type="step"}_getDefaultName(){return TextInterpolation.assetName}static assetId="54593ea0-ace0-41d2-ac4a-4147a92356b7";static assetName="Text Interpolation";static isPrivate=!0}Pe.registerAsset(TextInterpolation),ge.loadPrivate(TextInterpolation);ye.registerEditorHelper(class extends InterpolationHelper{constructor(e){super(e)}static fields=[]},TextInterpolation);const{LibraryHandler:Ie,ProjectHandler:be}=window.DigitalBacon;class VectorInterpolation extends Interpolation{constructor(e={}){e.assetId=VectorInterpolation.assetId,super(e)}_getDefaultName(){return VectorInterpolation.assetName}exportParams(){return super.exportParams()}_getLinearValue(e,t){let s=this._keyframe[this._parameter].slice(),i=t[this._parameter].slice();for(let t=0;t<s.length;t++)s[t]=(i[t]-s[t])*e+s[t];return s}static assetId="2ab2e72d-14ae-4f89-8b0b-ae23e7f7259b";static assetName="Vector Interpolation";static isPrivate=!0}be.registerAsset(VectorInterpolation),Ie.loadPrivate(VectorInterpolation);const{Assets:ve,EditorHelpers:Ae,LibraryHandler:Ee,ProjectHandler:we,PubSub:Fe,THREE:Te,getMenuController:xe,isEditor:He,utils:Ce}=window.DigitalBacon,{CustomAssetEntity:je}=ve,{CustomAssetEntityHelper:Se,EditorHelperFactory:Me}=Ae,{AssetSetField:ke,ButtonField:Ne,CheckboxField:Be,ColorField:Ve,EulerField:Ke,NumberField:Le,TextField:Oe,Vector2Field:De,Vector3Field:Re}=Se.FieldTypes,{numberOr:Qe}=Ce;var ze,qe,Ue;new Te.Vector3,new Te.Vector3;const Ge=new Set([Be,Ve,Ke,Le,Oe,De,Re]),We=["position","rotation","scale","renderOrder"],Ye={position:PositionInterpolation.assetId,rotation:RotationInterpolation.assetId,scale:ScaleInterpolation.assetId},Je={ColorField:ColorInterpolation.assetId,EulerField:EulerInterpolation.assetId,NumberField:NumberInterpolation.assetId,TextField:TextInterpolation.assetId,Vector2Field:VectorInterpolation.assetId,Vector3Field:VectorInterpolation.assetId};class Keyframe extends je{constructor(e={}){e.assetId=Keyframe.assetId,super(e),this._time=Qe(e.time,0),this.parameters={},this._interpolations=new Set,this._parameterInterpolations={},e.parameters&&this.setParameters(e.parameters),e.interpolations&&(this.interpolations=e.interpolations)}_getDefaultName(){return Keyframe.assetName}exportParams(){let e=super.exportParams();return e.time=this._time,e.parameters=this.parameters,e.interpolations=this.interpolations,e.parentId=null,e}get interpolations(){let e=[];for(let t of this._interpolations)e.push(t.id);return e}get position(){return super.position}get time(){return this._time}set interpolations(e){for(let t of e)this.addInterpolation(t)}set position(e){super.position=e,this._animationPath&&this._animationPath.onKeyframePositionUpdate(this)}set time(e){this._time=e,this._animationPath&&this._animationPath.updateKeyframes()}addInterpolation(e){let t=we.getAsset(e);t&&(this._interpolations.add(t),t.registerKeyframe(this),this._parameterInterpolations[t.parameter]=t,this.editorHelper&&!(t.parameter in this.parameters)&&(this.editorHelper.addParameter(t.parameter),this._animationPath&&this._animationPath.updateKeyframes()))}addParameter(e,t){if(this.parameters[t]=e,this._animationPath&&this._animationPath.updateKeyframes(),We.includes(e.parameter)){if(He()&&this._animationPath){let t=this._animationPath._animatedAssets.values().next().value;t&&(this[e.parameter]=t[e.parameter])}}else Object.defineProperty(this,e.parameter,{get:function(){return e.value},set:function(t){e.value=t}})}removeInterpolation(e){let t=we.getSessionAsset(e);if(this._interpolations.delete(t),!t)return;let s=t.parameter;delete this.parameters[s],this.editorHelper&&this.editorHelper.deleteParameter(s),"position"==s&&(t.hideCurve(),this._animationPath&&this._animationPath.updateKeyframes())}setParameters(e){for(let t in e)this.addParameter(e[t],t)}registerAnimationPath(e){this.editorHelper&&this.editorHelper.updateVisualEdit(this.visualEdit),this._animationPath=e,this.addTo(e);for(let e of this._interpolations)e.registerKeyframe(this)}interpolate(e,t,s){return this._parameterInterpolations[e].getValue(t,s)}onAddToProject(){this._animationPath&&this._animationPath.addKeyframe(this._id)}onRemoveFromProject(){super.onRemoveFromProject(),this._animationPath.removeKeyframe(this._id)}static assetId="401fcf91-49ef-480b-992d-e55ac0c65d4e";static assetName="Keyframe";static isPrivate=!0}if(we.registerAsset(Keyframe),Ee.loadPrivate(Keyframe),Ae){class KeyframeHelper extends Se{constructor(e){super(e),this._addParameterFields(),this._createMesh()}_addParameter(){let e=this._asset._animationPath?._animatedAssets;if(e?.size){let t={};for(let s of e){let e=s.editorHelper;this._loadAssetParams(t,e.constructor)}let s=xe();s.getPage("ASSET_SELECT").setContent(t,(e=>{let i,r=t[e];this._asset.addParameter(r,e),"position"==e&&this._asset.visualEdit&&this._object.add(this._mesh),this._menuFieldsMap[r.parameter]?i=this._menuFieldsMap[r.parameter]:(i=this._createStandardField(r),this._menuFieldsMap[r.parameter]=i),s.back();let a=s.getCurrentPage();a._setFields([]),this._menuFields.splice(this._menuFields.length-1,0,i),a.setAsset(this._asset,!0);let o=this._menuFields.length;for(;a._lastItemIndex+1!=o;)a._loadNextPage();this._createInterpolation(r)})),s.pushPage("ASSET_SELECT")}else Fe.publish(this._id,"MENU_NOTIFICATION",{text:"Please add an asset to the animation path first"})}addParameter(e){let t=this._asset._animationPath?._animatedAssets;if(!t?.size)return;let s={};for(let e of t){let t=e.editorHelper;this._loadAssetParams(s,t.constructor)}let i=s[e];if(!i)return;this._asset.parameters[e]=i;let r,a=xe(),o=a.getPage("CUSTOM_ASSET"),n=a.getCurrentPage()==o&&o._asset==this._asset;n&&o._setFields([]),this._menuFieldsMap[e]?r=this._menuFieldsMap[e]:(r=this._createStandardField(i),this._menuFieldsMap[i.parameter]=r),r&&this._menuFields.splice(this._menuFields.length-1,0,r),n&&o.setAsset(this._asset,!0),"position"==e&&this.updateVisualEdit(this._asset.visualEdit)}deleteParameter(e){let t=xe(),s=t.getPage("CUSTOM_ASSET"),i=t.getCurrentPage()==s&&s._asset==this._asset;i&&s._setFields([]);let r=this._menuFieldsMap[e],a=this._menuFields.indexOf(r);r&&a>=0&&this._menuFields.splice(a,1),i&&s.setAsset(this._asset,!0),"position"==e&&this.updateVisualEdit(this._asset.visualEdit)}_addParameterFields(){for(let e in this._asset.parameters){let t,s=this._asset.parameters[e];this._menuFields||this.getMenuFields(),this._menuFieldsMap[s.parameter]?t=this._menuFieldsMap[s.parameter]:(t=this._createStandardField(s),this._menuFieldsMap[s.parameter]=t),this._menuFields.splice(this._menuFields.length-1,0,t)}}_createInterpolation(e){let t,s={parameter:e.parameter,name:e.name};t=e.parameter in Ye?Ye[e.parameter]:e.type in Je?Je[e.type]:StepInterpolation.assetId;let i=we.addNewAsset(t,s);this._asset.addInterpolation(i.id)}_loadAssetParams(e,t){if(!t)return;let s=Object.getPrototypeOf(t);if(this._loadAssetParams(e,s),t.fields)for(let s of t.fields){if("string"==typeof s||!Ge.has(s.type)||"visualEdit"==s.parameter)continue;let t=s.parameter;t in e||t in this._asset.parameters||(e[t]=this._cloneField(s))}}_cloneField(e){let t={};for(let s in e)t[s]=e[s];return t.Name=t.name,t.type=t.type.name,t}_createMesh(){ze||((ze=(new Te.TextureLoader).load("https://cdn.jsdelivr.net/gh/kalegd/digitalbacon-plugins@latest/textures/Digital_Bacon_Piggy.jpg")).repeat.x=5,ze.repeat.y=2.5,ze.offset.x=-3.25,ze.offset.y=-.75,ze.colorSpace=Te.SRGBColorSpace,qe=new Te.SphereGeometry(.05),Ue=new Te.MeshBasicMaterial({color:16777215,map:ze})),this._mesh=new Te.Mesh(qe,Ue),this._asset.visualEdit&&this._asset.parameters.position&&this._object.add(this._mesh)}updateVisualEdit(e){e&&this._asset.parameters.position?this._object.add(this._mesh):this._object.remove(this._mesh),super.updateVisualEdit(e)}hideMesh(){this._object.remove(this._mesh);let e=this._asset._parameterInterpolations.position;e&&e.hideCurve()}static fields=["visualEdit",{parameter:"time",name:"Time",min:0,type:Le},{parameter:"interpolations",name:"Interpolations",addFunction:"addInterpolation",removeFunction:"removeInterpolation",type:ke},{parameter:"_addParameter",name:"Add Parameter",type:Ne}]}Me.registerEditorHelper(KeyframeHelper,Keyframe)}const{Assets:Xe,EditorHelpers:Ze,LibraryHandler:$e,ProjectHandler:et,Scene:tt,THREE:st,isEditor:it,isImmersionDisabled:rt}=window.DigitalBacon,{AssetEntity:at,CustomAssetEntity:ot}=Xe,{CustomAssetEntityHelper:nt,EditorHelperFactory:lt}=Ze,{AssetSetField:dt,ButtonField:pt,CheckboxField:ht}=nt.FieldTypes;new st.Euler;const mt=new st.Quaternion,ut=new st.Vector3;var ct,_t=0;class AnimationPath extends ot{constructor(e={}){e.assetId=AnimationPath.assetId,e.position=e.rotation=[0,0,0],super(e),this._animatedAssets=new Set,this._keyframes=new Set,this._orderedKeyframes=[],this._orderedParameters={},this._maxTime=0,this._scrollBased=e.scrollBased||!1,e.animatedAssets&&(this.animatedAssets=e.animatedAssets),e.keyframes&&(this.keyframes=e.keyframes),it()||this._scrollBased&&rt()&&(this.update=this._updateScrollBased)}_getDefaultName(){return AnimationPath.assetName}exportParams(){let e=super.exportParams();return e.animatedAssets=this.animatedAssets,e.keyframes=this.keyframes,e.scrollBased=this.scrollBased,e}get animatedAssets(){let e=[];for(let t of this._animatedAssets)e.push(t.id);return e}get keyframes(){let e=[];for(let t of this._keyframes)e.push(t.id);return e}get scrollBased(){return this._scrollBased}set animatedAssets(e){for(let t of e)this.addAnimatedAsset(t)}set keyframes(e){for(let t of e)this.addKeyframe(t,!0);this.updateKeyframes()}set scrollBased(e){this._scrollBased=e}addAnimatedAsset(e){let t=et.getAsset(e);t&&this._animatedAssets.add(t)}addKeyframe(e,t){let s=et.getAsset(e);s&&(this._keyframes.add(s),s.registerAnimationPath(this),t||this.updateKeyframes())}removeAnimatedAsset(e){let t=et.getSessionAsset(e);t&&this._animatedAssets.delete(t)}removeKeyframe(e){let t=et.getSessionAsset(e);this._keyframes.delete(t),this.updateKeyframes(),t.editorHelper&&t.editorHelper.hideMesh()}getNextKeyframeFor(e,t){let s=this._orderedParameters[e];if(s)for(let e=0;e<s.length;e++){if(s[e]==t){if(e==s.length-1)return;return s[e+1]}}}updateKeyframes(){if(this._orderedParameters={},this._orderedKeyframes=Array.from(this._keyframes),this._orderedKeyframes=this._orderedKeyframes.sort(((e,t)=>e.time-t.time)),this._orderedKeyframes.length){for(let e of this._orderedKeyframes)for(let t in e.parameters){let s=e.parameters[t].parameter;this._orderedParameters[s]||(this._orderedParameters[s]=[]),this._orderedParameters[s].push(e)}this._maxTime=Math.max(0,this._orderedKeyframes[this._orderedKeyframes.length-1].time),this._scrollBased&&(_t=Math.max(_t,this._maxTime)),this._updatePositionInterpolationCurves()}}_updatePositionInterpolationCurves(){let e=this._orderedParameters.position;if(e)for(let t of e){let e=t._parameterInterpolations.position;e&&e.updateCurve()}}onKeyframePositionUpdate(e){let t=this._orderedParameters.position;if(!t)return;let s=t.indexOf(e);if(t<0)return;let i=e._parameterInterpolations.position;i&&i.updateCurve(),s>0&&(i=(e=t[s-1])._parameterInterpolations.position,i&&i.updateCurve())}_setTime(e){for(let t in this._orderedParameters){let s,i=this._orderedParameters[t],r=i[0];for(let t=1;t<i.length&&(s=i[t],!(e<=s.time));t++)r=s,s=null;let a=r.interpolate(t,e,s);this._updateAssets(t,a)}}_updateAssets(e,t){for(let s of this._animatedAssets)if(s[e]=t,s instanceof at!=0)if("position"==e)s._object.parent.worldToLocal(s._object.position);else if("rotation"==e){let e=s._object.quaternion;e.setFromEuler(s._object.rotation),s._object.parent.getWorldQuaternion(mt),e.premultiply(mt.invert())}else"scale"==e&&(s._object.parent.getWorldScale(ut),s._object.scale.divide(ut))}_updateScrollBased(){let e=document.body.scrollHeight-window.innerHeight,t=window.scrollY,s=Math.min(Math.max(t/e,0),1);if(s==this._lastScrollPercent)return;this._lastScrollPercent=s;let i=s*_t;this._setTime(i)}static assetId="2d227485-0b34-40a4-873d-2a0782d034c6";static assetName="Animation Path";static getMaxTime(){return _t}}if(et.registerAsset(AnimationPath),Ze){function getAssets(){let e=et.getAssets(),t=[];for(let s in e){let i=e[s];"InternalAssetEntity"!=i.constructor.name&&(i.isPrivate||i.constructor.isPrivate||t.push(s))}return t}class AnimationPathHelper extends nt{constructor(e){super(e)}preview(){ct?tt.object.add(ct.object):((ct=new AnimationController).registerAnimationPathClass(AnimationPath),tt.object.add(ct.object),lt.addEditorHelperTo(ct),ct.editorHelper.updateVisualEdit(!0)),ct.setPositionFromMenu()}static fields=["visualEdit",{parameter:"scrollBased",name:"Scroll Based",type:ht},{parameter:"animatedAssets",name:"Assets",addFunction:"addAnimatedAsset",removeFunction:"removeAnimatedAsset",optionsFunction:getAssets,type:dt},{parameter:"keyframes",name:"Keyframes",addFunction:"addKeyframe",removeFunction:"removeKeyframe",newOptionsFunction:()=>[Keyframe.assetId],type:dt},{parameter:"preview",name:"Preview",type:pt},"parentId","position","rotation","scale"]}lt.registerEditorHelper(AnimationPathHelper,AnimationPath)}export{AnimationPath as default};
